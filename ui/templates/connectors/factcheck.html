{% extends "base.html" %}
{% block content %}

<section class="bg-slate-900 min-h-screen px-6 py-24 relative overflow-hidden">
  
  <div class="absolute top-[-10%] right-[-10%] w-[600px] h-[600px] bg-indigo-500/10 blur-[120px] rounded-full"></div>
  <div class="absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-blue-500/5 blur-[120px] rounded-full"></div>

  <div class="max-w-7xl mx-auto relative z-10 space-y-24">

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-start">
      <div data-aos="fade-right" class="pt-8">
        <div id="statusBadge" class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-slate-700 bg-slate-800/50 text-slate-400 text-[10px] font-mono mb-8 tracking-widest uppercase">
          <span class="h-2 w-2 rounded-full bg-slate-600"></span>
          NOT CONNECTED
        </div>

        <h1 class="text-7xl font-black text-white tracking-tighter mb-6">
          Fact <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-blue-400">Check</span>
        </h1>
        <p class="text-slate-300 text-xl mb-10 leading-relaxed font-medium max-w-xl">
          Leverage the Google Fact Check Tools API to ingest verified claims, claimant details, and truth ratings into your local warehouse for disinformation analysis.
        </p>

        <div class="flex flex-wrap gap-4 items-center mt-6">
          <div class="px-6 py-3 border border-indigo-500/30 bg-indigo-500/5 rounded-2xl text-indigo-300 font-mono text-sm">
            API_VERSION: V1ALPHA1
          </div>
        </div>
      </div>

      <div class="relative" data-aos="zoom-in">
        <div id="connectSection" class="relative bg-slate-800/60 backdrop-blur-xl border border-white/10 p-10 rounded-[3.5rem] shadow-2xl transition-all duration-500">
          <div class="flex justify-between mb-10 px-2">
            <div class="flex flex-col items-center gap-2">
              <div id="step1-circle" class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xs font-bold transition-all duration-300">1</div>
              <span class="text-[9px] font-mono text-indigo-400 uppercase tracking-tighter">Credentials</span>
            </div>
            <div class="flex-1 h-[1px] bg-slate-700 mt-4 mx-2"></div>
            <div class="flex flex-col items-center gap-2">
              <div id="step2-circle" class="w-8 h-8 rounded-full bg-slate-700 text-slate-500 flex items-center justify-center text-xs font-bold transition-all duration-300">2</div>
              <span class="text-[9px] font-mono text-slate-500 uppercase tracking-tighter">Activate</span>
            </div>
            <div class="flex-1 h-[1px] bg-slate-700 mt-4 mx-2"></div>
            <div class="flex flex-col items-center gap-2">
              <div id="step3-circle" class="w-8 h-8 rounded-full bg-slate-700 text-slate-500 flex items-center justify-center text-xs font-bold transition-all duration-300">3</div>
              <span class="text-[9px] font-mono text-slate-500 uppercase tracking-tighter">Connected</span>
            </div>
          </div>

          <div id="credentialsForm" class="space-y-4 transition-opacity duration-500 opacity-100">
            <div id="apiKeyInputWrapper">
              <label class="text-[10px] font-mono text-slate-500 uppercase mb-2 block ml-2 tracking-widest">Google FactCheck API Key</label>
              <input id="apiKey" type="password" placeholder="Paste your API Key here" class="w-full px-6 py-4 bg-slate-900/50 border border-slate-700 rounded-2xl text-white placeholder-slate-600 focus:outline-none focus:border-indigo-400 transition-all shadow-inner hover:shadow-indigo-500/20">
            </div>
            
            <button id="mainActionBtn" onclick="handleMainAction()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black hover:bg-white hover:text-indigo-600 transition-all shadow-lg shadow-indigo-600/20 text-xs uppercase tracking-widest mt-2 hover:shadow-indigo-600/40">
              Save API Key
            </button>

            <div class="mt-8 pt-8 border-t border-white/5">
              <h4 class="text-white text-xs font-bold mb-4 uppercase tracking-widest">Setup Instructions</h4>
              <ul class="space-y-3">
                <li class="flex items-start gap-3 text-[11px] text-slate-400">
                  <span class="w-1.5 h-1.5 rounded-full bg-indigo-500 mt-1.5 shrink-0"></span>
                  <span>Enable <b>Fact Check Tools API</b> in Google Cloud Console.</span>
                </li>
              </ul>
            </div>
          </div>

          <div id="successState" class="hidden text-center space-y-8 transition-opacity duration-500 opacity-0 relative pt-4 pb-20">
            <div class="space-y-4">
              <svg class="w-20 h-20 mx-auto text-emerald-500 animate-pulse-once" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <h3 class="text-white text-3xl font-bold tracking-tight">
                Successfully Connected
              </h3>
              <p class="text-slate-300 text-base max-w-md mx-auto">
                Fact Check Tools API is now active and ready for claim ingestion.
              </p>
            </div>

            <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-full max-w-xs px-6">
              <button onclick="disconnectFactCheck()" id="disconnectBtn"
                      class="group relative w-full py-4 px-6 bg-transparent border-2 border-red-600/70 text-red-400 font-semibold rounded-2xl hover:bg-red-700/20 hover:border-red-500 hover:text-white transition-all duration-300">
                <span class="flex items-center justify-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7"/>
                  </svg>
                  Disconnect this connector
                </span>
              </button>
              <p class="text-center text-[11px] text-slate-500 mt-2">
                Revokes access and stops future syncs
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="syncDestinationSection" class="relative transition-all duration-500">
      <div id="accessOverlay" class="absolute inset-0 bg-slate-900/90 flex items-center justify-center z-20 rounded-[2.5rem]">
        <div class="text-center space-y-4 p-8 bg-slate-800/50 rounded-3xl border border-white/10 shadow-2xl">
          <div class="w-16 h-16 bg-indigo-500/20 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
            <svg class="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
          </div>
          <h3 class="text-white text-2xl font-black tracking-tight">Connect to Unlock</h3>
          <p class="text-slate-300 text-sm max-w-xs leading-relaxed">Establish a connection to access sync engine and warehouse destination settings.</p>
        </div>
      </div>

      <div id="syncContent" class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start opacity-65 blur-sm pointer-events-none">
        <div class="lg:col-span-1">
          <div class="bg-slate-800/60 backdrop-blur-md border border-white/10 p-8 rounded-[2.5rem] shadow-2xl">
            <div class="flex items-center gap-3 mb-8">
              <div class="w-10 h-10 bg-indigo-500/10 rounded-xl flex items-center justify-center border border-indigo-500/20">
                <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
              </div>
              <h3 class="text-white font-black text-xl">Sync Engine</h3>
            </div>
            
            <div class="space-y-6">
              <div>
                <label class="text-[10px] font-mono text-slate-500 uppercase mb-3 block tracking-widest">Search Query</label>
                <input id="queryInput" placeholder="Enter topic (e.g. AI safety, economy)" class="w-full p-4 rounded-xl bg-slate-900/80 text-white border border-white/10 focus:border-indigo-500 outline-none text-sm font-bold">
              </div>

              <div>
                <label class="text-[10px] font-mono text-slate-500 uppercase mb-3 block tracking-widest">Refresh Strategy</label>
                <select id="syncType" class="w-full p-4 rounded-xl bg-slate-900/80 text-white border border-white/10 focus:border-indigo-500 outline-none text-sm cursor-pointer hover:bg-slate-900 transition-all">
                  <option value="incremental">Incremental</option>
                  <option value="historical">Historical (Full)</option>
                </select>
              </div>

              <div>
                <label class="text-[10px] font-mono text-slate-500 uppercase mb-3 block tracking-widest">Daily Schedule</label>
                <div class="grid grid-cols-2 gap-3">
                  <div class="relative">
                    <select id="hourSelect" class="w-full p-4 rounded-xl bg-slate-900 text-white border border-white/10 appearance-none text-center font-bold focus:border-indigo-500 outline-none">
                      {% for h in range(0, 24) %}<option value="{{ '%02d' % h }}" class="bg-slate-800">{{ '%02d' % h }}</option>{% endfor %}
                    </select>
                  </div>
                  <div class="relative">
                    <select id="minSelect" class="w-full p-4 rounded-xl bg-slate-900 text-white border border-white/10 appearance-none text-center font-bold focus:border-indigo-500 outline-none">
                      {% for m in range(0, 60, 5) %}<option value="{{ '%02d' % m }}" class="bg-slate-800">{{ '%02d' % m }}</option>{% endfor %}
                    </select>
                  </div>
                </div>
              </div>

              <div class="pt-6 space-y-3">
                <button onclick="saveJob()" class="w-full py-4 bg-white/5 hover:bg-white/10 text-white border border-white/10 rounded-2xl font-bold transition-all text-xs uppercase tracking-widest">Update Schedule</button>
                <button onclick="runSync()" id="syncBtn" class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-black transition-all shadow-lg shadow-indigo-600/30 text-xs uppercase tracking-widest">Execute Search</button>
              </div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-2">
          <div class="bg-slate-800/60 backdrop-blur-md border border-white/10 p-8 rounded-[2.5rem] shadow-2xl h-full">
            <div class="flex items-center justify-between mb-8">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-500/10 rounded-xl flex items-center justify-center border border-emerald-500/20">
                  <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                  </svg>
                </div>
                <h3 class="text-white font-black text-xl tracking-tight">Warehouse Destination</h3>
              </div>
              <div id="destStatus" class="text-[10px] font-mono text-emerald-400 bg-emerald-500/10 px-4 py-1.5 rounded-full border border-emerald-500/20 uppercase font-bold tracking-tighter">System Ready</div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <div class="md:col-span-2 relative">
                <label class="text-[10px] font-mono text-slate-500 uppercase mb-2 block ml-2 tracking-widest">Target Platform</label>
                
                <div id="customSelectTrigger" onclick="toggleDropdown()" class="w-full px-6 py-4 bg-slate-900 border border-slate-700 rounded-2xl text-white flex items-center justify-between cursor-pointer hover:border-indigo-500 transition-all">
                  <div id="selectedOption" class="flex items-center gap-3">
                    <span class="text-slate-500">Select Connector...</span>
                  </div>
                  <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>

                <input type="hidden" id="destType" value="">

                <div id="dropdownMenu" class="hidden absolute w-full mt-2 bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl z-50 max-h-60 overflow-y-auto backdrop-blur-xl">
                  <div class="p-2 space-y-1">
                    <div onclick="selectDestination('mysql', 'MySQL', 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/mysql/mysql-original.svg')" class="flex items-center gap-3 px-4 py-3 hover:bg-indigo-500/10 rounded-xl cursor-pointer transition-colors group">
                      <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/mysql/mysql-original.svg" class="w-6 h-6 object-contain">
                      <span class="text-slate-200 group-hover:text-white font-medium">MySQL</span>
                    </div>
                    <div onclick="selectDestination('postgres', 'PostgreSQL', 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/postgresql/postgresql-original.svg')" class="flex items-center gap-3 px-4 py-3 hover:bg-indigo-500/10 rounded-xl cursor-pointer transition-colors group">
                      <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/postgresql/postgresql-original.svg" class="w-6 h-6 object-contain">
                      <span class="text-slate-200 group-hover:text-white font-medium">PostgreSQL</span>
                    </div>
                    <div onclick="selectDestination('bigquery', 'Google BigQuery', 'https://cdn.simpleicons.org/googlebigquery/4285F4')" class="flex items-center gap-3 px-4 py-3 hover:bg-indigo-500/10 rounded-xl cursor-pointer transition-colors group">
                      <img src="https://cdn.simpleicons.org/googlebigquery/4285F4" class="w-6 h-6 object-contain">
                      <span class="text-slate-200 group-hover:text-white font-medium">Google BigQuery</span>
                    </div>
                    <div onclick="selectDestination('snowflake', 'Snowflake', 'https://cdn.simpleicons.org/snowflake/29B5E8')" class="flex items-center gap-3 px-4 py-3 hover:bg-indigo-500/10 rounded-xl cursor-pointer transition-colors group">
                      <img src="https://cdn.simpleicons.org/snowflake/29B5E8" class="w-6 h-6 object-contain">  
                      <span class="text-slate-200 group-hover:text-white font-medium">Snowflake</span>
                    </div>
                    <div onclick="selectDestination('clickhouse', 'ClickHouse', 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/clickhouse/clickhouse-original.svg')" class="flex items-center gap-3 px-4 py-3 hover:bg-indigo-500/10 rounded-xl cursor-pointer transition-colors group">
                      <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/clickhouse/clickhouse-original.svg" class="w-6 h-6 object-contain">
                      <span class="text-slate-200 group-hover:text-white font-medium">ClickHouse</span>
                    </div>
                    <div onclick="selectDestination('s3', 'AWS S3', '')" class="flex items-center gap-3 px-4 py-3 hover:bg-indigo-500/10 rounded-xl cursor-pointer transition-colors group">
                      <img src="{{ url_for('static', filename='images/logos/s3.png') }}" class="w-6 h-6 object-contain">
                      <span class="text-slate-200 group-hover:text-white font-medium">AWS S3</span>
                    </div>
                  </div>
                </div>
              </div>

              <div id="dbFields" class="hidden md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-5 mt-6">
                <div id="sqlFields" class="contents">
                  <input id="dbHost" placeholder="Host (e.g. 127.0.0.1)" class="w-full p-4 rounded-xl bg-slate-900/50 text-white border border-white/5 focus:border-indigo-500 outline-none text-sm transition-all">
                  <input id="dbPort" placeholder="Port" class="w-full p-4 rounded-xl bg-slate-900/50 text-white border border-white/5 focus:border-indigo-500 outline-none text-sm transition-all">
                  <input id="dbUser" placeholder="Username" class="w-full p-4 rounded-xl bg-slate-900/50 text-white border border-white/5 focus:border-indigo-500 outline-none text-sm transition-all">
                  <input id="dbPass" type="password" placeholder="Password" class="w-full p-4 rounded-xl bg-slate-900/50 text-white border border-white/5 focus:border-indigo-500 outline-none text-sm transition-all">
                  <input id="dbName" placeholder="Database Name" class="md:col-span-2 w-full p-4 rounded-xl bg-slate-900/50 text-white border border-white/5 focus:border-indigo-500 outline-none text-sm transition-all">
                </div>
                <div id="bigqueryFields" class="hidden contents">
                  <input id="bqProject" placeholder="Project ID" class="w-full p-4 rounded-xl bg-slate-900/50 text-white border border-white/5 focus:border-indigo-500 outline-none text-sm transition-all">
                  <input id="bqDataset" placeholder="Dataset ID" class="w-full p-4 rounded-xl bg-slate-900/50 text-white border border-white/5 focus:border-indigo-500 outline-none text-sm transition-all">
                  <div class="md:col-span-2">
                    <textarea id="bqKey" placeholder="Service Account JSON Key" rows="3" class="w-full p-4 rounded-xl bg-slate-900/50 text-white border border-white/5 focus:border-indigo-500 outline-none text-sm transition-all resize-y font-mono"></textarea>
                  </div>
                </div>
                <div class="md:col-span-2 pt-2">
                  <button onclick="saveDestination()" id="saveDestBtn" class="w-full py-5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-black transition-all shadow-lg shadow-indigo-600/30 text-xs uppercase tracking-widest">Authenticate & Save</button>
                </div>
              </div>

              <div class="mt-8 pt-8 border-t border-white/5 md:col-span-2">
                <label class="text-[10px] font-mono text-slate-500 uppercase mb-3 block tracking-widest">Active Connection Switcher</label>
                <select id="destDropdown" onchange="activateDest(this.value)" class="w-full p-4 rounded-xl bg-slate-900/50 text-indigo-300 border border-indigo-500/20 outline-none text-sm font-bold cursor-pointer hover:bg-slate-900 transition-all">
                  <option value="">Loading connections...</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div>
      <h2 class="text-4xl font-black mb-16 text-center text-white tracking-tight">Claim <span class="text-indigo-400">Ingestion Logic</span></h2>
      <div class="grid md:grid-cols-3 gap-8">
        {% for step, title, desc in [
          ('01', 'Claim Search', 'Programmatic query of Google’s verified claim index based on specific keywords or topics.'),
          ('02', 'Metadata Mapping', 'Parsing claimant identity, publisher credibility, and original source timestamps.'),
          ('03', 'Rating Warehouse', 'Normalizing diverse truth ratings into a consistent relational schema for analysis.')
        ] %}
        <div class="group p-10 bg-slate-800/40 border border-white/5 rounded-[2.5rem] hover:bg-slate-800/80 transition-all hover:-translate-y-2">
          <div class="text-5xl font-black text-slate-700/30 mb-6 group-hover:text-indigo-400 transition-colors">{{step}}</div>
          <h3 class="text-2xl font-bold text-white mb-3">{{title}}</h3>
          <p class="text-slate-400 leading-relaxed text-sm">{{desc}}</p>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="pt-12">
      <h2 class="text-4xl font-black mb-12 text-center text-white tracking-tight">Warehouse <span class="text-indigo-400">Schema</span></h2>
      <div class="grid lg:grid-cols-2 gap-12 items-start">
        <div class="grid grid-cols-1 gap-4">
          {% for table, columns in [
            ('fact_claims', ['id', 'text', 'claimant', 'claim_date', 'query_id']),
            ('fact_reviews', ['id', 'claim_id', 'publisher', 'rating', 'review_url']),
            ('fact_queries', ['id', 'search_text', 'results_count', 'timestamp'])
          ] %}
          <div class="p-6 bg-slate-800/40 border border-white/5 rounded-3xl hover:border-indigo-500/30 transition-all group">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-3 h-3 rounded-full bg-indigo-600 group-hover:animate-pulse"></div>
                <h4 class="text-white font-mono font-bold text-sm tracking-widest uppercase">{{table}}</h4>
            </div>
            <div class="flex flex-wrap gap-2">
                {% for col in columns %}
                <span class="px-3 py-1.5 bg-slate-900/80 border border-white/10 rounded-xl text-[10px] font-mono text-slate-400">{{col}}</span>
                {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
        <div class="relative bg-slate-800 border border-white/10 rounded-[3rem] p-10 shadow-3xl sticky top-10">
          <div class="absolute inset-0 bg-indigo-600/5 rounded-[3rem] blur-xl"></div>
          <img src="/static/images/erd/factcheck_erd.png" class="relative z-10 mx-auto max-w-full rounded-2xl opacity-90 grayscale hover:grayscale-0 transition-all duration-700"/>
        </div>
      </div>
    </div>

    <div class="mb-32">
      <h2 class="text-4xl font-black mb-12 text-center text-white">Extraction Entities</h2>
      <div class="grid md:grid-cols-3 gap-6">
        {% for table in ['fact_claims', 'fact_reviews', 'fact_queries'] %}
        <div class="p-8 bg-slate-800/40 border border-white/5 rounded-[2rem] hover:bg-indigo-600/5 hover:border-indigo-500/20 transition-all flex flex-col items-center text-center group cursor-pointer">
          <div class="w-14 h-14 rounded-2xl bg-slate-900 flex items-center justify-center mb-6 group-hover:scale-110 group-hover:bg-indigo-600 transition-all duration-500 shadow-xl">
            <svg class="w-6 h-6 text-slate-500 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
          <span class="font-mono text-slate-400 font-bold text-sm tracking-widest group-hover:text-white transition-colors">{{table}}</span>
        </div>
        {% endfor %}
      </div>
    </div>

  </div>
</section>

<style>
  @keyframes pulse-once {
    0%,100% { opacity:1; }
    50% { opacity:.6; }
  }
  .animate-pulse-once {
    animation: pulse-once 2s ease-in-out;
  }
</style>

<script>
let isApiKeySaved = false;
let isConnected = false;

document.addEventListener("DOMContentLoaded", () => {
    checkFactCheckStatus();
    loadDestinations();
    loadJob();
});

async function checkFactCheckStatus(){
    try {
        const res = await fetch("/api/status/factcheck");
        const data = await res.json();
        isConnected = data.connected;
        isApiKeySaved = data.api_key_saved;
        updateAuthUI();
    } catch(e) { console.error(e); }
}

function updateAuthUI(){
    const s1 = document.getElementById("step1-circle");
    const s2 = document.getElementById("step2-circle");
    const s3 = document.getElementById("step3-circle");
    const btn = document.getElementById("mainActionBtn");
    const badge = document.getElementById("statusBadge");
    const form = document.getElementById("credentialsForm");
    const success = document.getElementById("successState");
    const syncContent = document.getElementById("syncContent");
    const accessOverlay = document.getElementById("accessOverlay");

    if (isConnected) {
        badge.innerHTML = `<span class="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></span> CONNECTED`;
        badge.className = "inline-flex items-center gap-2 px-3 py-1 rounded-full border border-emerald-500/30 bg-emerald-500/5 text-emerald-400 text-[10px] font-mono mb-8 uppercase tracking-widest";

        s1.className = "w-8 h-8 rounded-full bg-emerald-500 text-white flex items-center justify-center text-xs font-bold transition-all duration-300";
        s1.innerHTML = "✓";
        s2.className = "w-8 h-8 rounded-full bg-emerald-500 text-white flex items-center justify-center text-xs font-bold transition-all duration-300";
        s2.innerHTML = "✓";
        s3.className = "w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xs font-bold transition-all duration-300";

        form.classList.add("hidden");
        success.classList.remove("hidden");
        success.classList.add("opacity-100");

        syncContent.classList.remove("opacity-65", "blur-sm", "pointer-events-none");
        accessOverlay.classList.add("hidden");
    } 
    else if (isApiKeySaved) {
        badge.innerHTML = `<span class="h-2 w-2 rounded-full bg-yellow-500"></span> CREDENTIALS SAVED`;
        badge.className = "inline-flex items-center gap-2 px-3 py-1 rounded-full border border-yellow-500/30 bg-yellow-500/5 text-yellow-400 text-[10px] font-mono mb-8 uppercase tracking-widest";

        s1.className = "w-8 h-8 rounded-full bg-emerald-500 text-white flex items-center justify-center text-xs font-bold transition-all duration-300";
        s1.innerHTML = "✓";
        s2.className = "w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xs font-bold transition-all duration-300";

        btn.innerText = "Activate Fact Check";
        btn.className = "w-full py-5 bg-white text-indigo-600 rounded-2xl font-black hover:bg-indigo-600 hover:text-white transition-all shadow-lg text-xs uppercase tracking-widest mt-2 hover:shadow-indigo-600/40";
        btn.onclick = handleMainAction;
    } 
    else {
        badge.innerHTML = `<span class="h-2 w-2 rounded-full bg-slate-600"></span> NOT CONNECTED`;

        s1.className = "w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xs font-bold transition-all duration-300";

        btn.innerText = "Save API Key";
        btn.onclick = handleMainAction;
    }
}

async function handleMainAction(){
    if(!isApiKeySaved){
        const api_key = document.getElementById("apiKey").value.trim();
        if(!api_key) return alert("Please enter an API key");
        try {
            const res = await fetch("/connectors/factcheck/save_config", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ api_key })
            });
            if(res.ok){
                isApiKeySaved = true;
                updateAuthUI();
            }
        } catch(e) { alert("Save failed"); }
    } else {
        try {
            const res = await fetch("/connectors/factcheck/connect");
            if(res.ok){
                isConnected = true;
                updateAuthUI();
            }
        } catch(e) { alert("Activation failed"); }
    }
}

async function disconnectFactCheck(){
    if(!confirm("Disconnecting will stop all future Fact Check syncs.\n\nContinue?")) return;
    const btn = document.getElementById("disconnectBtn");
    btn.disabled = true;
    btn.innerText = "Disconnecting...";

    try{
        const res = await fetch("/connectors/factcheck/disconnect");
        if(res.ok){
            alert("Connection revoked.");
            location.reload();
        }
        else{
            alert("Failed to disconnect.");
        }
    }catch(e){
        alert("Disconnect error.");
    }
}

// ────────────────────────────────────────────────
// All your original destination/sync/job logic remains unchanged below
// ────────────────────────────────────────────────

async function loadDestinations(){
    try {
        const res = await fetch(`http://localhost:4000/destination/list/factcheck`);
        const data = await res.json();
        const dropdown = document.getElementById("destDropdown");
        const statusEl = document.getElementById("destStatus");
        dropdown.innerHTML = '<option value="" class="text-slate-500 italic">Select an existing configuration...</option>';
        if(data.destinations?.length){
            data.destinations.forEach(d => {
                const opt = document.createElement("option");
                opt.value = d.id;
                opt.textContent = `${d.active ? '● ' : ''}${d.type.toUpperCase()} | ${d.database} (@${d.host || '—'})`;
                if(d.active) { opt.selected = true; statusEl.innerText = "Connection Active"; }
                dropdown.appendChild(opt);
            });
        } else { statusEl.innerText = "No destination configured"; }
    } catch(e) { console.error(e); }
}

async function activateDest(id){
    if(!id) return;
    const res = await fetch("http://localhost:4000/destination/activate", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ source: "factcheck", dest_id: id })
    });
    if(res.ok) loadDestinations();
}

function toggleDest() {
    const type = document.getElementById("destType").value;
    const wrapper = document.getElementById("dbFields");
    const sql = document.getElementById("sqlFields");
    const bq = document.getElementById("bigqueryFields");
    if(!type){ wrapper.classList.add("hidden"); return; }
    wrapper.classList.remove("hidden");
    if(type === "bigquery"){ sql.classList.add("hidden"); bq.classList.remove("hidden"); } 
    else { sql.classList.remove("hidden"); bq.classList.add("hidden"); }
}

async function saveDestination(){
    const btn = document.getElementById("saveDestBtn");
    btn.innerText = "AUTHENTICATING..."; btn.disabled = true;
    const type = document.getElementById("destType").value;
    let payload = { source: "factcheck", type };
    if(type === "bigquery"){
        payload.host = document.getElementById("bqProject")?.value || "";
        payload.database = document.getElementById("bqDataset")?.value || "";
        payload.password = document.getElementById("bqKey")?.value || "";
    } else if(type) {
        payload.host = document.getElementById("dbHost").value;
        payload.port = document.getElementById("dbPort").value;
        payload.username = document.getElementById("dbUser").value;
        payload.password = document.getElementById("dbPass").value;
        payload.database = document.getElementById("dbName").value;
    }
    try {
        const res = await fetch("http://localhost:4000/destination/save", {
            method: "POST", headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        });
        if(res.ok) {
            btn.innerText = "SAVED ✓";
            loadDestinations();
            setTimeout(() => { btn.innerText = "Authenticate & Save"; btn.disabled = false; }, 2000);
        }
    } catch(e) { alert("Connection failed"); btn.disabled = false; }
}

async function loadJob(){
    try {
        const data = await fetch("/connectors/factcheck/job/get").then(r => r.json());
        if(data.schedule_time){
            const [h, m] = data.schedule_time.split(':');
            document.getElementById("hourSelect").value = h;
            document.getElementById("minSelect").value = m;
            document.getElementById("syncType").value = data.sync_type || "incremental";
        }
    } catch(e) {}
}

async function saveJob(){
    const time = `${document.getElementById("hourSelect").value}:${document.getElementById("minSelect").value}`;
    const res = await fetch("/connectors/factcheck/job/save", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sync_type: document.getElementById("syncType").value, schedule_time: time })
    });
    if(res.ok) alert("Job Schedule Updated");
}

async function runSync(){
    const query = document.getElementById("queryInput").value.trim();
    if(!query) return alert("Please enter a search query");
    const btn = document.getElementById("syncBtn");
    btn.innerText = "SEARCHING..."; btn.disabled = true;
    try {
        const res = await fetch(`http://localhost:4000/connectors/factcheck/sync?query=${encodeURIComponent(query)}&sync_type=${document.getElementById("syncType").value}`);
        const d = await res.json();
        btn.innerText = (d.status === "ok" || d.fetched !== undefined) ? `SYNCED (${d.fetched || 0} CLAIMS)` : "FAILED";
    } catch(e) { btn.innerText = "FAILED"; } 
    finally { setTimeout(() => { btn.innerText = "Execute Search"; btn.disabled = false; }, 3000); }
}

function toggleDropdown() {
    const menu = document.getElementById('dropdownMenu');
    menu.classList.toggle('hidden');
}

function selectDestination(value, label, logoUrl) {
    document.getElementById('destType').value = value;

    const selectedDiv = document.getElementById('selectedOption');
    const clickedElement = event.currentTarget;
    const imgClone = clickedElement.querySelector('img')?.cloneNode(true);

    selectedDiv.innerHTML = '';
    if (imgClone) selectedDiv.appendChild(imgClone);
    const textSpan = document.createElement('span');
    textSpan.className = "text-white font-bold";
    textSpan.innerText = label;
    selectedDiv.appendChild(textSpan);

    document.getElementById('dropdownMenu').classList.add('hidden');
    toggleDestFields(value);
}

function toggleDestFields(type) {
    const fields = document.getElementById("dbFields");
    if(!type){
        fields.classList.add("hidden");
        return;
    }
    fields.classList.remove("hidden");

    document.getElementById("sqlFields").classList.toggle("hidden", type === "bigquery" || type === "s3");
    document.getElementById("bigqueryFields").classList.toggle("hidden", type !== "bigquery");
    document.getElementById("s3Fields").classList.toggle("hidden", type !== "s3");
    document.getElementById("formatField").classList.toggle("hidden", !(type === "bigquery" || type === "s3"));
}

window.onclick = function(event) {
    if (!event.target.closest('#customSelectTrigger') && !event.target.closest('#dropdownMenu')) {
        document.getElementById('dropdownMenu').classList.add('hidden');
    }
}
</script>

{% endblock %}