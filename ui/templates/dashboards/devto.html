{% extends "base.html" %}
{% block content %}

<section class="bg-slate-950 min-h-screen px-6 py-12 font-sans text-slate-200 relative overflow-hidden">
    <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-cyan-500/5 blur-[120px] rounded-full -z-0"></div>

    <div class="max-w-7xl mx-auto relative z-10">
        
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
            <div>
                <h1 class="text-3xl font-extrabold text-white tracking-tight">
                    Dev.to <span class="text-cyan-400">Dashboard</span>
                </h1>
                <p class="text-slate-400 mt-1">Monitor community articles, tags, and engagement metrics.</p>
            </div>

            <div class="flex items-center gap-3">
                <div class="relative">
                    <select id="tableSelect" 
                        class="appearance-none bg-slate-900 border border-slate-700 rounded-lg text-white pl-4 pr-10 py-2.5 focus:outline-none focus:ring-2 focus:ring-cyan-500/50 transition-all cursor-pointer">
                        <option value="articles">Articles</option>
                        <option value="tags">Tags</option>
                    </select>
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500 text-xs">
                        â–¼
                    </div>
                </div>

                <button onclick="loadData()" id="loadBtn"
                    class="px-6 py-2.5 bg-cyan-500 hover:bg-cyan-400 text-slate-950 rounded-lg font-bold transition-all transform active:scale-95 shadow-lg shadow-cyan-500/20">
                    Load Data
                </button>

                <button onclick="syncNow()" id="syncBtn"
                    class="px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-white border border-slate-600 rounded-lg font-bold transition-all transform active:scale-95 shadow-lg">
                    Sync Now
                </button>

                <button onclick="exportToCSV()" id="exportBtn"
                    class="hidden px-4 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-lg font-medium border border-slate-600 transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                    Export
                </button>
            </div>
        </div>

        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl overflow-hidden backdrop-blur-sm shadow-2xl min-h-[400px]">
            <div class="overflow-x-auto custom-scrollbar">
                <table id="dataTable" class="w-full text-left border-collapse">
                    <thead id="tableHead" class="bg-slate-800/80 border-b border-slate-700 sticky top-0 z-20">
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-800">
                        <tr>
                            <td class="p-32 text-center text-slate-500 italic">
                                <div class="text-4xl mb-4 opacity-20">ðŸ“‘</div>
                                Select a category and click "Load Data" to begin.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #22d3ee; }

    .json-preview {
        max-width: 250px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

<script>
let currentData = []; 

async function loadData() {
    const tableType = document.getElementById("tableSelect").value;
    const btn = document.getElementById("loadBtn");
    const exportBtn = document.getElementById("exportBtn");
    const body = document.getElementById("tableBody");
    
    btn.innerText = "Processing...";
    btn.disabled = true;

    try {
        const response = await fetch("/api/devto/data/" + tableType);
        currentData = await response.json();
        renderTable(currentData);
        exportBtn.classList.remove('hidden');
    } catch (err) {
        body.innerHTML = `<tr><td class="p-8 text-red-400 text-center font-mono uppercase text-xs tracking-widest">ERR_FETCH_FAILED</td></tr>`;
    } finally {
        btn.innerText = "Load Data";
        btn.disabled = false;
    }
}

function renderTable(data) {
    const head = document.getElementById("tableHead");
    const body = document.getElementById("tableBody");

    if (!data || data.length === 0) {
        head.innerHTML = "";
        body.innerHTML = '<tr><td class="p-20 text-center text-slate-500">No records found.</td></tr>';
        return;
    }

    const keys = Object.keys(data[0]);
    head.innerHTML = `<tr>${keys.map(k => `
        <th class="px-6 py-4 text-[10px] font-black uppercase tracking-[0.2em] text-cyan-400">${k.replace(/_/g, ' ')}</th>
    `).join('')}</tr>`;

    body.innerHTML = data.map(row => `
        <tr class="hover:bg-white/[0.03] transition-colors group">
            ${keys.map(key => {
                let val = row[key];
                let display = val;
                
                // --- Reference Formatting Logic ---
                if (val === null || val === undefined) {
                    display = '<span class="opacity-20">â€”</span>';
                } else if (typeof val === 'object') {
                    display = `<span class="text-xs font-mono text-slate-500 italic">{Object}</span>`;
                } else if (typeof val === 'string' && val.length > 50) {
                    display = `
                        <div class="json-preview cursor-help text-cyan-500/80" onclick="alert('Full View:\\n\\n' + this.getAttribute('data-full'))" data-full="${val.replace(/"/g, '&quot;')}">
                            ${val.slice(0, 47)}...
                        </div>
                    `;
                }

                return `
                    <td class="px-6 py-4 text-sm text-slate-300 group-hover:text-white border-b border-slate-800/50">
                        ${display}
                    </td>
                `;
            }).join('')}
        </tr>
    `).join('');
}

async function syncNow() {
    const btn = document.getElementById("syncBtn");
    const originalText = btn.innerText;
    
    btn.innerText = "Syncing...";
    btn.disabled = true;

    try {
        const response = await fetch("/connectors/devto/sync");
        if (!response.ok) throw new Error();
        
        btn.innerText = "Success";
        btn.classList.replace('bg-slate-800', 'bg-emerald-600');
        
        // Auto-refresh the current view
        loadData();
        
        setTimeout(() => {
            btn.innerText = "Sync Now";
            btn.classList.replace('bg-emerald-600', 'bg-slate-800');
            btn.disabled = false;
        }, 3000);
    } catch (err) {
        btn.innerText = "Failed";
        btn.classList.replace('bg-slate-800', 'bg-red-600');
        setTimeout(() => {
            btn.innerText = "Sync Now";
            btn.classList.replace('bg-red-600', 'bg-slate-800');
            btn.disabled = false;
        }, 3000);
    }
}

function exportToCSV() {
    if (currentData.length === 0) return;

    const headers = Object.keys(currentData[0]);
    const csvRows = [
        headers.join(','),
        ...currentData.map(row => 
            headers.map(fieldName => {
                let val = row[fieldName] === null ? "" : row[fieldName];
                if (typeof val === 'object') val = JSON.stringify(val);
                return `"${String(val).replace(/"/g, '""')}"`;
            }).join(',')
        )
    ];

    const blob = new Blob([csvRows.join('\r\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    const fileName = `devto_${document.getElementById("tableSelect").value}_${new Date().toISOString().split('T')[0]}.csv`;

    link.setAttribute("href", url);
    link.setAttribute("download", fileName);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>

{% endblock %}