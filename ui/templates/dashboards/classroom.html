{% extends "base.html" %}
{% block content %}

<section class="bg-slate-950 min-h-screen px-6 py-12 font-sans text-slate-200 relative overflow-hidden">
    <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-yellow-500/5 blur-[120px] rounded-full -z-0"></div>

    <div class="max-w-7xl mx-auto relative z-10">
        
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
            <div>
                <h1 class="text-3xl font-extrabold text-white tracking-tight">
                    Classroom <span class="text-yellow-500">Dashboard</span>
                </h1>
                <p class="text-slate-400 mt-1">LMS management: Courses, enrollment rosters, and coursework tracking.</p>
            </div>

            <div class="flex items-center gap-2 overflow-x-auto pb-2 md:pb-0 no-scrollbar">
                <div class="flex items-center gap-1.5 bg-slate-900/80 p-1.5 border border-slate-800 rounded-xl backdrop-blur-md">
                    <button onclick="load('courses',this)" class="nav-btn active">Courses</button>
                    <button onclick="load('teachers',this)" class="nav-btn">Teachers</button>
                    <button onclick="load('students',this)" class="nav-btn">Students</button>
                    <button onclick="load('coursework',this)" class="nav-btn">Work</button>
                    <button onclick="load('submissions',this)" class="nav-btn">Submissions</button>
                </div>
            </div>
        </div>

        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl overflow-hidden backdrop-blur-sm shadow-2xl min-h-[450px]">
            <div class="overflow-x-auto custom-scrollbar">
                <table id="dataTable" class="w-full text-left border-collapse">
                    <thead id="thead" class="bg-slate-800/80 border-b border-slate-700 sticky top-0 z-20">
                    </thead>
                    <tbody id="tbody" class="divide-y divide-slate-800">
                        <tr>
                            <td class="p-32 text-center text-slate-500 italic">
                                <div class="text-4xl mb-4 opacity-20">ðŸŽ“</div>
                                Fetching educational data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-8 p-6 bg-slate-900/30 border border-slate-800 rounded-2xl flex items-center justify-between">
            <div>
                <h3 class="font-bold text-white">Classroom Sync</h3>
                <p class="text-sm text-slate-400">Re-index rosters and sync coursework states from the Google Classroom API.</p>
            </div>
            <button onclick="syncClassroom()" class="px-6 py-2.5 bg-yellow-600 hover:bg-yellow-500 text-slate-950 rounded-lg font-bold shadow-lg shadow-yellow-900/20 transition-all flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
                Sync Rosters
            </button>
        </div>
    </div>
</section>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #eab308; }

    .nav-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        font-weight: 700;
        color: #94a3b8;
        border-radius: 0.5rem;
        transition: all 0.2s;
        white-space: nowrap;
    }
    .nav-btn:hover { color: #fff; background: #1e293b; }
    .nav-btn.active { 
        background: #eab308; 
        color: #020617; 
        box-shadow: 0 4px 12px rgba(234, 179, 8, 0.2);
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
</style>

<script>
let currentRows = [];

// ---------------- LOAD ----------------

async function load(type, btn) {
    if(btn) {
        document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
    }

    const tbody = document.getElementById("tbody");
    tbody.innerHTML = `<tr><td class="p-20 text-center animate-pulse text-slate-500 italic uppercase tracking-widest text-[10px]">HANDSHAKING_WITH_LMS_SERVICE...</td></tr>`;

    try {
        const r = await fetch(`/api/classroom/${type}`);
        const data = await r.json();
        currentRows = data;

        if (!data.length) {
            document.getElementById("thead").innerHTML = "";
            tbody.innerHTML = '<tr><td class="p-20 text-center text-slate-500 font-medium">No records found for this category.</td></tr>';
            return;
        }

        render(Object.keys(data[0]), data);
    } catch (err) {
        tbody.innerHTML = `<tr><td class="p-8 text-red-400 text-center font-mono text-xs">ERR_CLASSROOM_API_FETCH_FAILED</td></tr>`;
    }
}

// ---------------- RENDER ----------------

function render(cols, rows) {
    const thead = document.getElementById("thead");
    const tbody = document.getElementById("tbody");

    thead.innerHTML = `<tr>${cols.map(c => `
        <th class="px-6 py-4 text-[10px] font-black uppercase tracking-[0.2em] text-yellow-500">${c.replace(/_/g, ' ')}</th>
    `).join('')}</tr>`;

    tbody.innerHTML = rows.map(r => `
        <tr class="hover:bg-white/[0.03] transition-colors group">
            ${cols.map(c => {
                let val = r[c] ?? "";
                let display = val;

                // Logic for status badges
                if (c === 'state' || c === 'courseState' || c === 'status') {
                    const color = val === 'ACTIVE' || val === 'PUBLISHED' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-slate-800 text-slate-400 border-slate-700';
                    display = `<span class="px-2 py-0.5 rounded text-[10px] font-bold border ${color}">${val}</span>`;
                }
                // Formatting for IDs and Names
                else if (c.includes('Name')) {
                    display = `<span class="font-semibold text-white">${val}</span>`;
                }
                else if (c.includes('Id')) {
                    display = `<span class="font-mono text-slate-500 text-[10px]">${val}</span>`;
                }

                return `<td class="px-6 py-4 text-sm border-b border-slate-800/50">${display}</td>`;
            }).join('')}
        </tr>
    `).join('');
}

// ---------------- ACTIONS ----------------

async function syncClassroom() {
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    btn.innerHTML = "Syncing...";
    btn.disabled = true;

    try {
        await fetch("/connectors/classroom/sync");
        load("courses", document.querySelector(".nav-btn"));
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Default
load("courses", document.querySelector(".nav-btn"));
</script>

{% endblock %}