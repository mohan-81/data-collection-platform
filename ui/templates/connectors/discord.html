{% extends "base.html" %}
{% block content %}

<section class="bg-slate-900 min-h-screen px-6 py-24 relative overflow-hidden">
  
  <div class="absolute top-[-10%] right-[-10%] w-[600px] h-[600px] bg-indigo-600/10 blur-[120px] rounded-full"></div>
  <div class="absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-blue-500/5 blur-[120px] rounded-full"></div>

  <div class="max-w-7xl mx-auto relative z-10 space-y-32">

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-start">
      <div data-aos="fade-right" class="pt-8">
        <div id="statusBadge" class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-slate-700 bg-slate-800/50 text-slate-400 text-[10px] font-mono mb-8 tracking-widest uppercase">
          <span id="statusDot" class="h-2 w-2 rounded-full bg-slate-600"></span>
          <span id="statusText">NOT CONNECTED</span>
        </div>

        <h1 class="text-7xl font-black text-white tracking-tighter mb-6">
            Discord <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-purple-400">Connector</span>
        </h1>
        <p class="text-slate-300 text-lg mb-6 leading-relaxed font-medium max-w-xl">
          Sync server messages, member activity, and channel analytics directly from your Discord Guilds into your data warehouse using a Bot Token.
        </p>

        <div class="space-y-4 text-slate-400 text-sm max-w-lg mb-10">
          <div class="flex gap-3">
            <svg class="w-5 h-5 text-indigo-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <span>Your Bot must have 'Server Members' and 'Message Content' intents enabled in the Discord Developer Portal.</span>
          </div>
        </div>

        <div class="flex flex-wrap gap-4 items-center">
            <a href="/dashboard/discord" id="dashboardBtn" class="px-10 py-4 bg-white/5 border border-white/10 text-white rounded-2xl font-bold hover:bg-white hover:text-indigo-900 transition-all shadow-xl">Dashboard</a>
            <button onclick="disconnectDiscord()" id="disconnectBtn" class="hidden px-10 py-4 bg-red-900/20 border border-red-500/50 text-red-400 rounded-2xl font-bold hover:bg-red-600 hover:text-white transition-all">Disconnect</button>
        </div>
      </div>

      <div class="relative" data-aos="zoom-in">
        <div id="connectSection" class="relative bg-slate-800/60 backdrop-blur-xl border border-white/10 p-10 rounded-[3.5rem] shadow-2xl">
          
          <div class="flex justify-between mb-10 px-2">
            <div class="flex flex-col items-center gap-2">
              <div id="step1-circle" class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xs font-bold transition-all">1</div>
              <span id="step1-label" class="text-[9px] font-mono text-indigo-400 uppercase tracking-tighter font-bold">App Token</span>
            </div>
            <div id="line1" class="flex-1 h-[1px] bg-slate-700 mt-4 mx-2"></div>
            <div class="flex flex-col items-center gap-2">
              <div id="step2-circle" class="w-8 h-8 rounded-full bg-slate-700 text-slate-500 flex items-center justify-center text-xs font-bold transition-all">2</div>
              <span id="step2-label" class="text-[9px] font-mono text-slate-500 uppercase tracking-tighter">Authorize</span>
            </div>
            <div id="line2" class="flex-1 h-[1px] bg-slate-700 mt-4 mx-2"></div>
            <div class="flex flex-col items-center gap-2">
              <div id="step3-circle" class="w-8 h-8 rounded-full bg-slate-700 text-slate-500 flex items-center justify-center text-xs font-bold transition-all">3</div>
              <span id="step3-label" class="text-[9px] font-mono text-slate-500 uppercase tracking-tighter">Connected</span>
            </div>
          </div>

          <div id="credentialsForm" class="space-y-4">
            <div id="inputGroup" class="space-y-4">
                <div>
                    <label class="text-[10px] font-mono text-slate-500 uppercase mb-2 block ml-2 tracking-widest">Discord Bot Token</label>
                    <input id="bot_token" type="password" placeholder="MTAx..." class="w-full px-6 py-4 bg-slate-900/50 border border-slate-700 rounded-2xl text-white placeholder-slate-600 focus:outline-none focus:border-indigo-400 transition-all shadow-inner">
                </div>
            </div>

            <button id="authBtn" onclick="handleAuthAction()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black hover:bg-white hover:text-indigo-600 transition-all shadow-lg shadow-indigo-600/20 text-xs uppercase tracking-widest mt-2">
              Save Bot Token
            </button>

            <div class="mt-8 pt-8 border-t border-white/5">
              <h4 class="text-white text-xs font-bold mb-4 uppercase tracking-widest">Setup Instructions</h4>
              <ul class="space-y-3">
                <li class="flex items-start gap-3 text-[11px] text-slate-400">
                  <span class="w-1.5 h-1.5 rounded-full bg-indigo-500 mt-1.5 shrink-0"></span>
                  <span>Create a Bot at <a href="https://discord.com/developers/applications" target="_blank" class="text-indigo-400 underline italic">Discord Dev Portal</a>.</span>
                </li>
                <li class="flex items-start gap-3 text-[11px] text-slate-400">
                  <span class="w-1.5 h-1.5 rounded-full bg-indigo-500 mt-1.5 shrink-0"></span>
                  <span>Copy the Bot Token and paste it into the field above.</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
        <div class="lg:col-span-1">
            <div class="bg-slate-800/60 backdrop-blur-md border border-white/10 p-8 rounded-[2.5rem] shadow-2xl">
                <div class="flex items-center gap-3 mb-8">
                    <div class="w-10 h-10 bg-indigo-500/10 rounded-xl flex items-center justify-center border border-indigo-500/20">
                        <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </div>
                    <h3 class="text-white font-black text-xl">Sync Engine</h3>
                </div>
                <div class="space-y-6">
                    <div>
                        <label class="text-[10px] font-mono text-slate-500 uppercase mb-3 block tracking-widest">Refresh Strategy</label>
                        <select id="syncType" class="w-full p-4 rounded-xl bg-slate-900/80 text-white border border-white/10 focus:border-indigo-500 outline-none text-sm cursor-pointer hover:bg-slate-900 transition-all">
                            <option value="historical">Historical (Full Load)</option>
                            <option value="incremental" selected>Incremental (Delta)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-mono text-slate-500 uppercase mb-3 block tracking-widest">Daily Schedule</label>
                        <div class="grid grid-cols-2 gap-3">
                            <select id="hourSelect" class="w-full p-4 rounded-xl bg-slate-900 text-white border border-white/10 text-center font-bold">
                                {% for h in range(0, 24) %}<option value="{{ '%02d' % h }}">{{ '%02d' % h }}</option>{% endfor %}
                            </select>
                            <select id="minSelect" class="w-full p-4 rounded-xl bg-slate-900 text-white border border-white/10 text-center font-bold">
                                {% for m in range(0, 60, 5) %}<option value="{{ '%02d' % m }}">{{ '%02d' % m }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="pt-6 space-y-3">
                        <button onclick="saveJob()" class="w-full py-4 bg-white/5 hover:bg-white/10 text-white border border-white/10 rounded-2xl font-bold transition-all text-xs uppercase tracking-widest">Update Schedule</button>
                        <button onclick="runSync()" id="syncBtn" class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-black transition-all shadow-lg shadow-indigo-600/30 text-xs uppercase tracking-widest">Run Manual Sync</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="bg-slate-800/60 backdrop-blur-md border border-white/10 p-8 rounded-[2.5rem] shadow-2xl h-full">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-500/10 rounded-xl flex items-center justify-center border border-blue-500/20">
                            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                            </svg>
                        </div>
                        <h3 class="text-white font-black text-xl tracking-tight">Warehouse Destination</h3>
                    </div>
                    <div id="destStatus" class="text-[10px] font-mono text-blue-400 bg-blue-500/10 px-4 py-1.5 rounded-full border border-blue-500/20 uppercase font-bold tracking-tighter">System Ready</div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <div class="md:col-span-2 relative">
                <label class="text-[10px] font-mono text-slate-500 uppercase mb-2 block ml-2 tracking-widest">Target Platform</label>
                
                <div id="customSelectTrigger" onclick="toggleDropdown()" class="w-full px-6 py-4 bg-slate-900 border border-slate-700 rounded-2xl text-white flex items-center justify-between cursor-pointer hover:border-rose-500 transition-all">
                    <div id="selectedOption" class="flex items-center gap-3">
                        <span class="text-slate-500">Select Connector...</span>
                    </div>
                    <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>

                <input type="hidden" id="destType" value="">

                <div id="dropdownMenu" class="hidden absolute w-full mt-2 bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl z-50 max-h-60 overflow-y-auto backdrop-blur-xl">
                    <div class="p-2 space-y-1">
                        <div onclick="selectDestination('mysql', 'MySQL', 'https://www.mysql.com/common/logos/logo-mysql-170x115.png')" class="flex items-center gap-3 px-4 py-3 hover:bg-rose-500/10 rounded-xl cursor-pointer transition-colors group">
                            <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/mysql/mysql-original.svg" class="w-6 h-6 object-contain">
                            <span class="text-slate-200 group-hover:text-white font-medium">MySQL</span>
                        </div>
                        <div onclick="selectDestination('postgres', 'PostgreSQL', '')" class="flex items-center gap-3 px-4 py-3 hover:bg-rose-500/10 rounded-xl cursor-pointer transition-colors group">
                            <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/postgresql/postgresql-original.svg" class="w-6 h-6 object-contain">
                            <span class="text-slate-200 group-hover:text-white font-medium">PostgreSQL</span>
                        </div>
                        <div onclick="selectDestination('bigquery', 'Google BigQuery', '')" class="flex items-center gap-3 px-4 py-3 hover:bg-rose-500/10 rounded-xl cursor-pointer transition-colors group">
                            <img src="https://cdn.simpleicons.org/googlebigquery/4285F4" class="w-6 h-6 object-contain">
                            <span class="text-slate-200 group-hover:text-white font-medium">Google BigQuery</span>
                        </div>
                        <div onclick="selectDestination('snowflake', 'Snowflake', '')" class="flex items-center gap-3 px-4 py-3 hover:bg-rose-500/10 rounded-xl cursor-pointer transition-colors group">
                          <img src="https://cdn.simpleicons.org/snowflake/29B5E8" class="w-6 h-6 object-contain">  
                          <span class="text-slate-200 group-hover:text-white font-medium">Snowflake</span>
                        </div>
                        <div onclick="selectDestination('clickhouse', 'ClickHouse', '')" class="flex items-center gap-3 px-4 py-3 hover:bg-rose-500/10 rounded-xl cursor-pointer transition-colors group">
                            <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/clickhouse/clickhouse-original.svg" class="w-6 h-6 object-contain">
                            <span class="text-slate-200 group-hover:text-white font-medium">ClickHouse</span>
                        </div>
                        <div onclick="selectDestination('s3', 'AWS S3', '')" class="flex items-center gap-3 px-4 py-3 hover:bg-rose-500/10 rounded-xl cursor-pointer transition-colors group">
                          <img src="{{ url_for('static', filename='images/logos/s3.png') }}" class="w-6 h-6 object-contain">
                          <span class="text-slate-200 group-hover:text-white font-medium">AWS S3</span>
                        </div>
                    </div>
                </div>
            </div>

                    <div id="dbFields" class="hidden md:contents animate-in fade-in duration-500">
                        <div id="sqlFields" class="contents">
                            <input id="dbHost" placeholder="Host" class="w-full p-4 rounded-xl bg-slate-900/50 text-white border border-white/5 outline-none text-sm">
                            <input id="dbPort" placeholder="Port" class="w-full p-4 rounded-xl bg-slate-900/50 text-white border border-white/5 outline-none text-sm">
                            <input id="dbUser" placeholder="Username" class="w-full p-4 rounded-xl bg-slate-900/50 text-white border border-white/5 outline-none text-sm">
                            <input id="dbPass" type="password" placeholder="Password" class="w-full p-4 rounded-xl bg-slate-900/50 text-white border border-white/5 outline-none text-sm">
                            <input id="dbName" placeholder="Database Name" class="md:col-span-2 w-full p-4 rounded-xl bg-slate-900/50 text-white border border-white/5 outline-none text-sm">
                        </div>
                        <div class="md:col-span-2 pt-2">
                            <button onclick="saveDestination()" id="saveDestBtn" class="w-full py-5 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl font-black transition-all shadow-lg shadow-blue-600/30 text-xs uppercase tracking-widest">Authenticate & Save</button>
                        </div>
                    </div>
                </div>
                <div class="mt-8 pt-8 border-t border-white/5">
                    <label class="text-[10px] font-mono text-slate-500 uppercase mb-3 block tracking-widest">Active Connection Switcher</label>
                    <select id="destDropdown" onchange="activateDest(this.value)" class="w-full p-4 rounded-xl bg-black/40 text-blue-300 border border-blue-500/20 outline-none text-sm font-bold">
                        <option value="">Loading connections...</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto relative z-10 pt-16 pb-24">
      <h2 class="text-4xl font-black mb-16 text-center text-white tracking-tight">
        Extraction <span class="text-indigo-400">Section</span>
      </h2>
      <div class="grid md:grid-cols-3 gap-8">
        {% for step, title, desc in [
          ('01', 'Gateway Socket', 'Establishing a real-time connection to Discord WebSocket for event streaming.'),
          ('02', 'Channel Crawler', 'Recursively traversing authorized guilds and mapping channel hierarchies.'),
          ('03', 'Payload Analysis', 'Parsing message JSON and indexing attachments into relational storage.')
        ] %}
        <div class="group p-10 bg-slate-800/40 border border-white/5 rounded-[2.5rem] hover:bg-slate-800/80 transition-all hover:-translate-y-2">
          <div class="text-5xl font-black text-slate-700/30 mb-6 group-hover:text-indigo-400 transition-colors">{{step}}</div>
          <h3 class="text-2xl font-bold text-white mb-3">{{title}}</h3>
          <p class="text-slate-400 leading-relaxed text-sm">{{desc}}</p>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="max-w-7xl mx-auto relative z-10 pt-16 pb-24">
      <h2 class="text-4xl font-black mb-12 text-center text-white tracking-tight">
        Relational <span class="text-indigo-400">Schema & ERD</span>
      </h2>
      
      <div class="grid lg:grid-cols-2 gap-12 items-start">
        <div class="grid grid-cols-1 gap-4">
          {% for table, columns in [
            ('discord_messages', ['id', 'channel_id', 'author_id', 'content', 'timestamp', 'attachments']),
            ('discord_members', ['id', 'username', 'discriminator', 'joined_at', 'roles', 'avatar_url']),
            ('discord_guilds', ['id', 'name', 'owner_id', 'member_count', 'premium_tier'])
          ] %}
          <div class="p-6 bg-slate-800/40 border border-white/5 rounded-3xl hover:border-indigo-500/30 transition-all group">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-3 h-3 rounded-full bg-indigo-600 group-hover:animate-pulse"></div>
                <h4 class="text-white font-mono font-bold text-sm tracking-widest uppercase">{{table}}</h4>
            </div>
            <div class="flex flex-wrap gap-2">
                {% for col in columns %}
                <span class="px-3 py-1.5 bg-slate-900/80 border border-white/10 rounded-xl text-[10px] font-mono text-slate-400">{{col}}</span>
                {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
        
        <div class="relative bg-slate-800 border border-white/10 rounded-[3rem] p-10 shadow-3xl sticky top-10">
          <div class="absolute inset-0 bg-indigo-600/5 rounded-[3rem] blur-xl"></div>
          <img src="/static/images/erd/discord_erd.png" class="relative z-10 mx-auto max-w-full rounded-2xl opacity-90 grayscale hover:grayscale-0 transition-all duration-700"/>
        </div>
      </div>
    </div>

  </div>

</section>

<script>
let isConnected = false;
let hasCredentials = false;

document.addEventListener("DOMContentLoaded", () => {
    checkStatus();
    loadDestinations();
    loadJob();
});

async function checkStatus(){
    try {
        const res = await fetch("/api/status/discord").then(r => r.json());
        isConnected = res.connected;
        hasCredentials = res.has_credentials;

        const authBtn = document.getElementById("authBtn");
        const inputGroup = document.getElementById("inputGroup");
        const disconnectBtn = document.getElementById("disconnectBtn");

        if(isConnected){
            updateStatusBadge("CONNECTED", "emerald");
            inputGroup.classList.add('hidden');
            authBtn.classList.add('hidden');
            disconnectBtn.classList.remove('hidden');
            updateSteps(3);
        } 
        else if (hasCredentials) {
            updateStatusBadge("TOKEN_SAVED", "indigo");
            inputGroup.classList.add('hidden');
            authBtn.innerText = "Connect Discord";
            authBtn.classList.remove('hidden');
            disconnectBtn.classList.add('hidden');
            updateSteps(2);
        }
        else {
            updateStatusBadge("NOT CONNECTED", "slate");
            inputGroup.classList.remove('hidden');
            authBtn.innerText = "Save Bot Token";
            authBtn.classList.remove('hidden');
            disconnectBtn.classList.add('hidden');
            updateSteps(1);
        }
    } catch(e) {}
}

function updateStatusBadge(text, color) {
    const badge = document.getElementById("statusBadge");
    const dot = document.getElementById("statusDot");
    const textEl = document.getElementById("statusText");

    textEl.innerText = text;
    if(color === "emerald") {
        badge.className = "inline-flex items-center gap-2 px-3 py-1 rounded-full border border-emerald-500/30 bg-emerald-500/10 text-emerald-400 text-[10px] font-mono mb-8 tracking-widest uppercase";
        dot.className = "h-2 w-2 rounded-full bg-emerald-500 animate-pulse";
    } else if (color === "indigo") {
        badge.className = "inline-flex items-center gap-2 px-3 py-1 rounded-full border border-indigo-500/30 bg-indigo-500/10 text-indigo-400 text-[10px] font-mono mb-8 tracking-widest uppercase";
        dot.className = "h-2 w-2 rounded-full bg-indigo-500 animate-pulse";
    } else {
        badge.className = "inline-flex items-center gap-2 px-3 py-1 rounded-full border border-slate-700 bg-slate-800/50 text-slate-400 text-[10px] font-mono mb-8 tracking-widest uppercase";
        dot.className = "h-2 w-2 rounded-full bg-slate-600";
    }
}

function updateSteps(step){
    const circles = [document.getElementById("step1-circle"), document.getElementById("step2-circle"), document.getElementById("step3-circle")];
    const labels = [document.getElementById("step1-label"), document.getElementById("step2-label"), document.getElementById("step3-label")];
    const lines = [document.getElementById("line1"), document.getElementById("line2")];

    circles.forEach((c, i) => {
        c.innerHTML = i + 1;
        c.className = "w-8 h-8 rounded-full bg-slate-700 text-slate-500 flex items-center justify-center text-xs font-bold transition-all";
    });
    labels.forEach(l => l.className = "text-[9px] font-mono text-slate-500 uppercase tracking-tighter");
    lines.forEach(l => l.className = "flex-1 h-[1px] bg-slate-700 mt-4 mx-2");

    for(let i=0; i<step; i++) {
        circles[i].className = "w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xs font-bold transition-all";
        labels[i].className = "text-[9px] font-mono text-indigo-400 uppercase tracking-tighter font-bold";
        if(i > 0) lines[i-1].className = "flex-1 h-[1px] bg-indigo-600 mt-4 mx-2";
        if(i < step - 1 || (step === 3)) {
            circles[i].innerHTML = "✓";
            circles[i].className = "w-8 h-8 rounded-full bg-emerald-500 text-white flex items-center justify-center text-xs font-bold transition-all";
        }
    }
}

async function handleAuthAction(){
    if (!hasCredentials) {
        const token = document.getElementById("bot_token").value;
        if(!token) return alert("Please enter a Bot Token");
        
        const res = await fetch("/connectors/discord/save_config", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ bot_token: token })
        });
        
        if(res.ok) checkStatus();
    } else {
        await fetch("/connectors/discord/connect");
        location.reload();
    }
}

function disconnectDiscord() {
    fetch("/connectors/discord/disconnect").then(() => location.reload());
}

async function loadDestinations(){
  try {
    const res = await fetch(`/destination/list/discord`);
    const data = await res.json();
    const dropdown = document.getElementById("destDropdown");
    const statusEl = document.getElementById("destStatus");
    dropdown.innerHTML = '<option value="">Select configuration...</option>';
    if(data.destinations?.length){
      data.destinations.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = `${d.active ? '● ' : ''}${d.type.toUpperCase()} | ${d.database}`;
        if(d.active) { opt.selected = true; statusEl.innerText = "Connection Active"; }
        dropdown.appendChild(opt);
      });
    }
  } catch(e) {}
}

async function saveDestination(){
  const btn = document.getElementById("saveDestBtn");
  btn.innerText = "AUTHENTICATING..."; btn.disabled = true;
  const type = document.getElementById("destType").value;
  let payload = { source: "discord", type, host: document.getElementById("dbHost").value, port: document.getElementById("dbPort").value, username: document.getElementById("dbUser").value, password: document.getElementById("dbPass").value, database: document.getElementById("dbName").value };
  
  const res = await fetch("/destination/save", {
    method: "POST", headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  });
  if(res.ok) {
    btn.innerText = "SAVED ✓";
    loadDestinations();
    setTimeout(() => { btn.innerText = "Authenticate & Save"; btn.disabled = false; }, 2000);
  }
}

function toggleDest() {
  const type = document.getElementById("destType").value;
  document.getElementById("dbFields").classList.toggle("hidden", !type);
}

async function loadJob(){
  try {
    const data = await fetch("/connectors/discord/job/get").then(r => r.json());
    if(data.schedule_time){
      const [h, m] = data.schedule_time.split(':');
      document.getElementById("hourSelect").value = h;
      document.getElementById("minSelect").value = m;
      document.getElementById("syncType").value = data.sync_type || "incremental";
    }
  } catch(e) {}
}

async function saveJob(){
  const time = `${document.getElementById("hourSelect").value}:${document.getElementById("minSelect").value}`;
  const res = await fetch("/connectors/discord/job/save", {
    method: "POST", headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ sync_type: document.getElementById("syncType").value, schedule_time: time })
  });
  if(res.ok) alert("Job Schedule Updated");
}

async function runSync(){
  const btn = document.getElementById("syncBtn");
  btn.innerText = "SYNCING..."; btn.disabled = true;
  try {
    const res = await fetch("/connectors/discord/sync");
    const d = await res.json();
    btn.innerText = d.status === "ok" ? `SYNCED (${d.messages || 0} MESSAGES)` : "FAILED";
  } catch(e) { btn.innerText = "FAILED"; }
  finally { setTimeout(() => { btn.innerText = "Run Manual Sync"; btn.disabled = false; }, 3000); }
}

function toggleDropdown() {
    const menu = document.getElementById('dropdownMenu');
    menu.classList.toggle('hidden');
}

function selectDestination(value, label, logoUrl) {
    // 1. Update the hidden input for your existing save logic
    document.getElementById('destType').value = value;

    // 2. Update the Trigger UI
    const logoHtml = logoUrl ? `<img src="${logoUrl}" class="w-5 h-5 object-contain">` : ''; // Fallback logic if needed
    
    // Using the icons from the options list
    const selectedDiv = document.getElementById('selectedOption');
    const clickedElement = event.currentTarget;
    const imgClone = clickedElement.querySelector('img').cloneNode(true);
    
    selectedDiv.innerHTML = '';
    selectedDiv.appendChild(imgClone);
    const textSpan = document.createElement('span');
    textSpan.className = "text-white font-bold";
    textSpan.innerText = label;
    selectedDiv.appendChild(textSpan);

    // 3. Hide menu
    document.getElementById('dropdownMenu').classList.add('hidden');

    // 4. Trigger your existing form field visibility logic
    toggleDestFields(value);
}

// Close dropdown if user clicks outside
window.onclick = function(event) {
    if (!event.target.closest('#customSelectTrigger') && !event.target.closest('#dropdownMenu')) {
        document.getElementById('dropdownMenu').classList.add('hidden');
    }
}

// Modified version of original toggleDest function
function toggleDestFields(type) {
    const fields = document.getElementById("dbFields");
    if(!type){
        fields.classList.add("hidden");
        return;
    }
    fields.classList.remove("hidden");

    document.getElementById("sqlFields").classList.toggle("hidden", type === "bigquery" || type === "s3");
    document.getElementById("bigqueryFields").classList.toggle("hidden", type !== "bigquery");
    document.getElementById("s3Fields").classList.toggle("hidden", type !== "s3");
    document.getElementById("formatField").classList.toggle("hidden", !(type === "bigquery" || type === "s3"));
}
</script>

{% endblock %}