{% extends "base.html" %}
{% block content %}

<section class="bg-slate-900 min-h-screen px-6 py-24 relative overflow-hidden">
  
  <div class="absolute top-[-10%] right-[-10%] w-[600px] h-[600px] bg-purple-600/10 blur-[120px] rounded-full"></div>
  <div class="absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-cyan-500/10 blur-[120px] rounded-full"></div>

  <div class="max-w-7xl mx-auto relative z-10">

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-center mb-32">
      <div data-aos="fade-right">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-purple-500/30 bg-purple-500/5 text-purple-400 text-[10px] font-mono mb-8 tracking-widest uppercase">
          <span class="relative flex h-2 w-2">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-purple-500 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-2 w-2 bg-purple-600"></span>
          </span>
          HELIX_API_ACTIVE
        </div>

        <h1 class="text-7xl font-black text-white tracking-tighter mb-6">
            Twitch <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-white">Connector</span>
        </h1>
        <p class="text-slate-300 text-xl mb-10 leading-relaxed font-medium">
          Monitor creator performance and audience engagement. This connector ingests live stream status, VOD metadata, and broadcaster profiles into your local database.
        </p>

        <div id="connectSection" class="flex flex-wrap gap-4 items-center">
          <form action="/connectors/twitch/connect" method="post" class="flex gap-2 bg-slate-800 p-2 rounded-2xl border border-slate-700 shadow-xl">
            <input name="username" placeholder="Twitch username" required 
                   class="bg-transparent border-none text-white px-4 py-2 focus:ring-0 font-medium placeholder:text-slate-500">
            <button type="submit" 
                    class="px-6 py-3 bg-purple-600 text-white rounded-xl font-black hover:bg-white hover:text-purple-600 transition-all">
              Connect
            </button>
          </form>
          <a href="/dashboard/twitch"
             class="px-8 py-4 border border-slate-700 text-white rounded-2xl font-bold hover:bg-slate-800 transition-all">
            Dashboard
          </a>
        </div>
      </div>

      <div class="flex justify-center items-center" data-aos="zoom-in">
        <div class="relative w-full max-w-[500px] h-[350px] bg-white/5 backdrop-blur-xl rounded-[3rem] border border-white/10 shadow-2xl flex items-center justify-center overflow-hidden">
            <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(#9146FF 1px, transparent 1px); background-size: 30px 30px;"></div>
            
            <div class="flex items-center justify-between w-full px-12 relative z-10">
                <div class="relative group">
                    <div class="absolute inset-0 bg-purple-500 blur-2xl opacity-40 animate-pulse"></div>
                    <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center relative shadow-2xl transform group-hover:rotate-6 transition-transform">
                        <img src="/static/images/logos/twitch.png" class="w-12 h-12">
                    </div>
                </div>

                <div class="flex-1 h-[2px] mx-4 relative bg-slate-700">
                    <div class="absolute inset-0 bg-gradient-to-r from-purple-500 to-white animate-[flow_2s_infinite_linear]"></div>
                </div>

                <div class="relative group">
                    <div class="absolute inset-0 bg-cyan-500 blur-2xl opacity-40 animate-pulse"></div>
                    <div class="w-20 h-20 bg-slate-800 border-2 border-cyan-400 rounded-full flex items-center justify-center relative shadow-2xl">
                        <svg class="w-10 h-10 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="absolute bottom-4 left-4 right-4 bg-black/40 backdrop-blur-md p-3 rounded-xl border border-white/5 font-mono text-[10px] text-purple-400 flex justify-between">
                <span id="protocolStatus" class="animate-pulse">● BROADCASTER_POLL_READY</span>
                <span class="text-slate-400 tracking-tighter">STORAGE_VERIFIED</span>
            </div>
        </div>
      </div>
    </div>

    <div class="mb-32">
      <h2 class="text-4xl font-black mb-16 text-center text-white tracking-tight">
        Stream Data <span class="text-purple-400">Flow</span>
      </h2>
      <div class="grid md:grid-cols-3 gap-8">
        {% for step, title, desc in [
          ('01', 'User Discovery', 'Locating broadcaster IDs via the Twitch Helix API using public usernames.'),
          ('02', 'Helix Ingestion', 'Capturing live stream state, current viewer counts, and game categories.'),
          ('03', 'Asset Archiving', 'Downloading VOD metadata and stream thumbnails to local indexed storage.')
        ] %}
        <div class="group p-10 bg-slate-800/40 border border-white/5 rounded-[2.5rem] hover:bg-slate-800/80 transition-all hover:-translate-y-2">
          <div class="text-5xl font-black text-slate-700/30 mb-6 group-hover:text-purple-500 transition-colors">{{step}}</div>
          <h3 class="text-2xl font-bold text-white mb-3">{{title}}</h3>
          <p class="text-slate-400 leading-relaxed">{{desc}}</p>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="mb-32">
      <h2 class="text-4xl font-black mb-12 text-center text-white tracking-tight">
        Database <span class="text-purple-400">Architecture</span>
      </h2>
      <div class="grid lg:grid-cols-2 gap-12 items-start">
        <div class="grid grid-cols-1 gap-4" data-aos="fade-right">
          {% for table, columns in [
            ('twitch_users', ['id', 'login', 'display_name', 'type', 'description', 'view_count', 'created_at']),
            ('twitch_streams', ['id', 'user_id', 'game_id', 'title', 'viewer_count', 'started_at', 'language']),
            ('twitch_videos', ['id', 'user_id', 'title', 'duration', 'view_count', 'type', 'published_at'])
          ] %}
          <div class="p-5 bg-slate-800/60 border border-white/5 rounded-2xl shadow-xl hover:border-purple-500/30 transition-colors">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-2 h-2 rounded-full bg-purple-500"></div>
                <h4 class="text-white font-mono font-bold text-sm">{{table}}</h4>
            </div>
            <div class="flex flex-wrap gap-2">
                {% for col in columns %}
                <span class="px-2 py-1 bg-slate-900/80 border border-white/10 rounded text-[10px] font-mono text-slate-400">{{col}}</span>
                {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
        <div class="relative bg-slate-800 border border-slate-700 rounded-3xl p-6 shadow-2xl sticky top-10" data-aos="fade-left">
          <img src="/static/images/erd/twitch_erd.png" class="mx-auto max-w-full rounded-xl opacity-90"/>
        </div>
      </div>
    </div>

    <div class="mb-32">
      <h2 class="text-4xl font-black mb-12 text-center text-white tracking-tight">Ingested Entities</h2>
      <div class="grid md:grid-cols-3 gap-6">
        {% for table in ['twitch_users', 'twitch_streams', 'twitch_videos'] %}
        <div class="p-8 bg-slate-800/40 border border-white/5 rounded-3xl hover:bg-purple-600/10 transition-all flex items-center justify-between group">
          <span class="font-mono text-slate-300 font-bold text-lg">{{table}}</span>
          <div class="w-10 h-10 rounded-xl bg-slate-900 flex items-center justify-center group-hover:bg-purple-600 transition-colors">
            <svg class="w-5 h-5 text-slate-500 group-hover:text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="bg-gradient-to-r from-slate-800 to-slate-900 border border-white/10 p-10 rounded-[2.5rem] shadow-2xl relative overflow-hidden text-center md:text-left">
      <div class="absolute inset-0 bg-purple-600 opacity-[0.02] animate-pulse"></div>
      <div class="flex flex-col md:flex-row items-center justify-between gap-8 relative z-10">
        <div>
            <h2 class="text-3xl font-black text-white mb-2">Initialize Twitch Sync?</h2>
            <p class="text-slate-400 font-medium">Specify a username to begin archiving stream metadata.</p>
        </div>
        <div class="flex gap-4">
            <button onclick="syncNow()" id="syncBtn"
                    class="px-8 py-4 bg-purple-600 text-white rounded-xl font-black hover:scale-105 transition-all flex items-center gap-2 shadow-xl shadow-purple-600/20">
              <svg id="syncIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
              Manual Sync
            </button>
        </div>
      </div>
    </div>

  </div>
</section>

<style>
  @keyframes flow { 0% { transform: translateX(-100%); } 100% { transform: translateX(400%); } }
  .animate-spin-slow { animation: spin 2s linear infinite; }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .bg-slate-900 {
    background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.035) 1px, transparent 0);
    background-size: 50px 50px;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function(){
  fetch("/api/status/twitch")
  .then(r => r.json())
  .then(d => {
    if(d.connected){
      document.getElementById("connectSection").innerHTML = `
        <div class="px-8 py-4 bg-emerald-500/10 border border-emerald-500/50 text-emerald-400 rounded-2xl font-black flex items-center gap-3">
          <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
          BROADCASTER_SYNC_ON
        </div>
        <a href="/dashboard/twitch" class="px-8 py-4 bg-slate-800 text-white border border-slate-700 rounded-2xl font-bold hover:bg-slate-700 transition-all">
          Open Dashboard
        </a>
      `;
      const statusLabel = document.getElementById("protocolStatus");
      if(statusLabel) {
          statusLabel.innerText = "● TWITCH_LIVESTREAM_MONITOR_ON";
          statusLabel.classList.replace("text-purple-400", "text-emerald-400");
      }
    }
  });
});

function syncNow(){
  let u = prompt("Enter Twitch username");
  if(!u) return;

  const btn = document.getElementById("syncBtn");
  const icon = document.getElementById("syncIcon");

  if(btn) { btn.innerText = "Syncing..."; btn.disabled = true; }
  if(icon) icon.classList.add("animate-spin-slow");

  fetch(`/connectors/twitch/sync?username=${u}`)
    .then(r => r.json())
    .then(() => {
      location.reload();
    })
    .catch(() => {
      alert("Sync failed");
      if(btn) { btn.innerText = "Manual Sync"; btn.disabled = false; }
      if(icon) icon.classList.remove("animate-spin-slow");
    });
}
</script>

{% endblock %}