{% extends "base.html" %}
{% block content %}

<section class="bg-slate-950 min-h-screen px-6 py-12 font-sans text-slate-200 relative overflow-hidden">
    <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-emerald-500/5 blur-[120px] rounded-full -z-0"></div>

    <div class="max-w-7xl mx-auto relative z-10">
        
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
            <div>
                <h1 class="text-3xl font-extrabold text-white tracking-tight">
                    PageSpeed <span class="text-emerald-400">Dashboard</span>
                </h1>
                <p class="text-slate-400 mt-1">Core Web Vitals, Lighthouse audits, and performance optimization tracking.</p>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="exportCSV()" id="exportBtn"
                    class="hidden px-4 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-lg font-medium border border-slate-600 transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                    Export
                </button>
            </div>
        </div>

        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl overflow-hidden backdrop-blur-sm shadow-2xl min-h-[400px]">
            <div class="overflow-x-auto custom-scrollbar">
                <table id="dataTable" class="w-full text-left border-collapse">
                    <thead id="thead" class="bg-slate-800/80 border-b border-slate-700 sticky top-0 z-20">
                    </thead>
                    <tbody id="rows" class="divide-y divide-slate-800">
                        <tr>
                            <td class="p-32 text-center text-slate-500 italic">
                                <div class="text-4xl mb-4 opacity-20">âš¡</div>
                                Analyzing page performance metrics...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-8 p-6 bg-slate-900/30 border border-slate-800 rounded-2xl flex items-center justify-between">
            <div>
                <h3 class="font-bold text-white">Lighthouse Audit Sync</h3>
                <p class="text-sm text-slate-400">Trigger new API requests to the PageSpeed Insights engine to re-scan monitored URLs.</p>
            </div>
            <button onclick="loadData()" class="px-6 py-2.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold shadow-lg shadow-emerald-900/20 transition-all flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
                Sync Audits
            </button>
        </div>
    </div>
</section>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #10b981; }

    .score-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-family: ui-monospace, monospace;
        font-weight: 700;
        font-size: 0.75rem;
    }
</style>

<script>
let rows = [];

// ---------------- LOAD ----------------

async function loadData() {
    const body = document.getElementById("rows");
    body.innerHTML = `<tr><td class="p-20 text-center animate-pulse text-slate-500 italic uppercase tracking-widest text-xs">RUNNING_LIGHTHOUSE_AUDITS...</td></tr>`;

    try {
        const r = await fetch("/api/pagespeed/data");
        rows = await r.json();
        render();
        document.getElementById("exportBtn").classList.remove('hidden');
    } catch (err) {
        body.innerHTML = `<tr><td class="p-8 text-red-400 text-center font-mono text-xs uppercase">ERR_PAGESPEED_API_FAILED</td></tr>`;
    }
}

// ---------------- RENDER ----------------

function getScoreColor(score) {
    if (score === null || score === undefined || score === "-") return "bg-slate-800 text-slate-500";
    const n = parseInt(score);
    if (n >= 90) return "bg-emerald-500/10 text-emerald-400 border border-emerald-500/20";
    if (n >= 50) return "bg-orange-500/10 text-orange-400 border border-orange-500/20";
    return "bg-red-500/10 text-red-400 border border-red-500/20";
}

function render() {
    const head = document.getElementById("thead");
    const body = document.getElementById("rows");

    head.innerHTML = "";
    body.innerHTML = "";

    if (rows.length === 0) {
        body.innerHTML = '<tr><td class="p-20 text-center text-slate-500 font-medium">No performance reports found.</td></tr>';
        return;
    }

    const displayKeys = ["url", "strategy", "performance", "seo", "accessibility", "best-practices", "pwa", "fetched_at"];

    // Header logic
    head.innerHTML = `<tr>${displayKeys.map(k => `
        <th class="px-6 py-4 text-[10px] font-black uppercase tracking-[0.2em] text-emerald-400">${k.replace(/-/g, ' ')}</th>
    `).join('')}</tr>`;

    // Row logic
    body.innerHTML = rows.map(d => `
        <tr class="hover:bg-white/[0.03] transition-colors group">
            <td class="px-6 py-4 text-sm font-medium text-cyan-400 border-b border-slate-800/50">
                <div class="max-w-xs truncate" title="${d.url}">${d.url}</div>
            </td>
            <td class="px-6 py-4 text-xs border-b border-slate-800/50">
                <span class="px-2 py-0.5 rounded bg-slate-800 text-slate-300 font-bold uppercase tracking-widest text-[10px]">
                    ${d.strategy}
                </span>
            </td>
            ${["performance", "seo", "accessibility", "best-practices", "pwa"].map(metric => `
                <td class="px-6 py-4 border-b border-slate-800/50">
                    <div class="score-badge ${getScoreColor(d[metric])}">
                        ${d[metric] ?? '-'}
                    </div>
                </td>
            `).join('')}
            <td class="px-6 py-4 text-[10px] font-mono text-slate-500 border-b border-slate-800/50">
                ${d.fetched_at}
            </td>
        </tr>
    `).join('');
}

// ---------------- EXPORT ----------------

function exportCSV() {
    if (rows.length === 0) return;
    const keys = Object.keys(rows[0]);
    const csvContent = [
        keys.join(','),
        ...rows.map(r => keys.map(k => `"${(r[k] || "").toString().replace(/"/g, '""')}"`).join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `pagespeed_audit_report_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
}

// ---------------- INIT ----------------

loadData();
</script>

{% endblock %}